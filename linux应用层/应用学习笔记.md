# 1、系统头文件   
## 1.1、`#include <sys/types.h>`   ->定义类型   
其中包括的常见类型有：  
```c
    pid_t    // 进程 ID
    uid_t    // 用户 ID
    gid_t    // 组 ID
    size_t   // 内存/长度
    off_t    // 文件偏移量
    ssize_t  // 有符号 size
```

## 1.2、`#include <sys/stat.h>`  ->  文件属性
常见内容：   
```c
    struct stat    // 文件信息结构体
``` 
常见函数：
```c
    stat() 
    fstat()
    lstat()
    mkdir()
    chmod()
    umask()
```
常见宏:
```c
    S_IFREG   // 普通文件
    S_IFDIR   // 目录
    S_IRUSR   // 用户读权限
    S_IWUSR   // 用户写权限
```

## 1.3、`#include <fcntl.h>` -> 打开/控制文件  
常见函数：
```C
    open()
    fcntl()
```
常见宏：
```c
    O_RDONLY
    O_WRONLY
    O_RDWR
    O_CREAT
    O_TRUNC
    O_APPEND
```

## 1.4、`#include <unistd.h>` -> 读写/进程/系统调用 POSIX操作系统API(重要)   
常见函数:
```c
    read()
    write()
    close()
    lseek()

    fork()
    exec()
    getpid()

    sleep()
    usleep()
```

## 1.5、 `#include <errno.h>` 系统错误头文件
常见宏：
```c
ENOENT：文件不存在
EACCES：权限不足
EBADF：fd 无效
ESPIPE：对不可 seek 的对象用了 lseek（管道/串口等）
```
<br>

# 2、文件IO基础
在文件IO基础里面，有好几个常用的函数，大部分包含在`#include <unistd.h>`里面，函数如下：<br>
## 2.1、open() 打开文件函数
基本语法：
```c
/*
param1: pathname 文件路径
param2: flags 打开方式  
        O_RDONLY(只读)、O_WRONLY(只写)、
        O_RDWR(读写)、O_CREAT(不存在就创建)、
        O_DIRECTORY(不是目录就打开失败)、O_EXCL(存在就报错)
        O_APPEND(write中,文件尾部追加)、O_TRUNC(文件内容清零)

param3: mode 权限
宏定义：
S_IRUSR     允许文件所属者读文件
S_IWUSR     允许文件所属者写文件
S_IXUSR     允许文件所属者执行文件
S_IRWXU     允许文件所属者读、写、执行文件
S_IRGRP     允许同组用户读文件
S_IWGRP     允许同组用户写文件
S_IXGRP     允许同组用户执行文件
S_IRWXG     允许同组用户读、写、执行文件
S_IROTH     允许其他用户读文件
S_IWOTH     允许其他用户写文件
S_IXOTH     允许其他用户执行文件
S_IRWXO     允许其他用户读、写、执行文件
S_ISUID     set-user-ID（特殊权限）
S_ISGID     set-group-ID（特殊权限）
S_ISVTX     sticky（特殊权限）

return: 文件描述符fd
*/
int open(const char *pathname, int flags, ... /* mode_t mode */);
```

## 2.2、write() 写文件
基本语法：
```c
#include <unistd.h>

/*
param1: fd 文件描述符
param2: *buf 指定写入的缓冲区
param3: count 写入的字节数
return: 成功：返回写入字节数；失败：返回-1
*/
ssize_t write(int fd, const void *buf, size_t count);
```

## 2.3 read() 读文件
基本语法：
```c
/*
param1: fd 文件描述符
param2: *buf 指定用于存储读取数据的缓冲区
param3: count 指定需要读取的字节数
return: 成功读取：读取到的字节数；
*/
ssize_t read(int fd, void *buf, size_t count);
```

## 2.4 close() 关闭文件
基本语法：
```c
#include <unistd.h>
/*
param1: fd 文件描述符
return: 成功：0；失败：-1
*/
int close(int fd);
```

## 2.5 lseek() 移动文件描述符fd的读写位置
基本语法：
```c
#include <unistd.h>
#include <sys/types.h>
/*
param2:offset 偏移量
param3:whence 用于定义参数 offset 偏移量对应的参考值
      SEEK_SET：从文件开头算，新位置=offset
      SEEK_CUR：从当前位置算，新位置=current + offset
      SEEK_END：从文件末尾算，新位置=file_size + offset 
return: 成功：返回从文件头部开始算起的位置偏移量；
        失败：-1
*/
off_t lseek(int fd, off_t offset, int whence);
```
<br>

# 3、深入研究文件IO
## 3.1、linux是如何管理文件的
**打开一个文件，系统内部会将这个过程分为三步:**
1) 系统找到这个文件名所对应的 inode 编号；  
2) 通过 inode 编号从 inode table 中找到对应的 inode 结构体；  
3) 根据 inode 结构体中记录的信息，确定文件数据所在的 block，并读出数据  
<br>

**文件打开后是什么状态？**  
当我们调用open函数去打开文件的时候，内核会申请一段内存(缓冲区)|(动态文件)，同时把磁盘里面的静态文件copy到动态文件里面，当我们对动态文件进行读写操作时候，动态文件和静态文件就不同步了，内核会在之后将内存进行同步。
<br>

## 3.2、exit _exit _Exit
我们的退出，一般正常退出用`return 0`，错误退出用`return -1`  
除了`return`以外，我们还可以使用exit()、_exit()、_Exit()，介绍如下：  
1)  
```c
/*
调用_exit()函数会清除其使用的内存空间，并销毁其在内核中的各种数据结构，关闭进程的所有文件描述符，并结束进程、将控制权交给操作系统。
status: 0 / -1
*/
void _exit(int status);   /*和_Exit()一样用法*/
```

2) `void exit(int status)` 

exit()函数_exit()函数都是用来终止进程的， exit()是一个标准 C 库函数，而_exit()和_Exit()是系统调用。执行 exit()会执行一些清理工作，最后调用_exit()函数。 该函数是一个标准 C 库函数，使用该函数需要包含头文件<stdlib.h>
  

## 3.3、O_APPEND和O_TRUNC标志
在open函数里面的flags中，有另外两个标志位，分别是O_APPEND和O_TRUNC  
1. `O_TRUNC`:调用 open 函数打开文件的时候会将文件原本的内容全部丢弃，文件大小变为 0  
2. `O_APPEND`:调用 open 函数打开文件，
当每次使用 write()函数对文件进行写操作时，都会自动把文件当前位置偏移量移动到文件末尾，从文件末尾开始写入数据，也就是意味着每次写入数据都是从文件末尾开始。


## 3.4、pread()和pwrite()

pread()和 pwrite()都是系统调用，与 read()、 write()函数的作用一样，用于读取和写入数据。区别在于，
pread()和 pwrite()可用于实现原子操作，调用 pread 函数或 pwrite 函数可传入一个位置偏移量 offset 参数，
用于指定文件当前读或写的位置偏移量，所以调用 pread 相当于调用 lseek 后再调用 read；同理，调用 pwrite
相当于调用 lseek 后再调用 write。

```c
#include <unistd.h>
ssize_t pread(int fd, void *buf, size_t count, off_t offset);
ssize_t pwrite(int fd, const void *buf, size_t count, off_t offset);
```

## 3.5、fcntl和ioctl函数
```c
/*
fd:文件描述符
cmd:操作命令
复制文件描述符（cmd=F_DUPFD 或 cmd=F_DUPFD_CLOEXEC）
获取/设置文件描述符标志（cmd=F_GETFD 或 cmd=F_SETFD）
获取/设置文件状态标志（cmd=F_GETFL 或 cmd=F_SETFL）
获取/设置异步 IO 所有权（cmd=F_GETOWN 或 cmd=F_SETOWN）
获取/设置记录锁（cmd=F_GETLK 或 cmd=F_SETLK）
return:失败-1 成功与cmd有关
*/
int fcntl(int fd, int cmd, .../*arg*/)
```


